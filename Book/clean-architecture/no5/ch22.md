# 22장 클린 아키텍처

> 여러 시스템 아키텍처의 세부적인 면에서 차이가 있더라도, 이들의 목표는 모두 **관심사의 분리**이다.
- 소프트웨어를 계층으로 분리함으로써 고나심사의 분리라는 목표를 달성할 수 있었다.
  - 각 아키텍처는 최소한 업무 규칙을 위한 계층 하나와, 사용자와 시스템 인터페이스를 위한 또 다른 계층 하나를 반드시 포함한다.
  - 또한 다음과 같은 특징을 갖는다.

1. 프레임워크 독립성
   1. 프레임워크의 존재 여부에 의존하지 않는다.
   2. 이를 통해 프레임워크를 도구로 사용할 수 있으며, 프레임워크의 제약사항을 시스템에 강제하지 않을 수 있다.
2. 테스트 용이성
   1. 핵심 로직은 외부 요소가 없어도 테스트가 가능하다.
3. UI 독립성
   1. 시스템의 나머지 부분을 변경하지 않아도 UI를 쉽게 변경할 수 있다.
4. 데이터베이스 독립성
   1. 업무 규칙은 데이터베이스에 결합되지 않는다.
   2. 변경 없이 갈아끼울 수 있다.
5. 모든 외부 에이전시에 대한 독립성
   1. 외부 인터페이스와 업무 규칙은 의존성이 존재하지 않는다.

## 의존성 규칙
- 클린 아키텍처에서 원 안으로 들어갈수록 고수준의 소프트웨어가 된다.
- 이러한 아키텍처가 동작하도록 하는 가장 중요한 규칙은 **의존성 규칙**이다.
> 소스 코드 의존성은 반드시 안쪽으로, 고수준의 정책을 향해야 한다.
- 고수준의 정책은 저수준을 의존하지 않는다.

## 엔티티
- 엔티티는 전사적인 핵심 업무 규칙을 캡슐화한다.
  - 메서드를 가지는 객체이거나, 일련의 데이터 구조와 함수의 집합일 수도 있다.
  - 재사용만 가능하면 형태는 그다지 중요하지 않다.
- 전사적이지 않은 단일 어플리케이션일 경우, 엔티티는 해당 어플리케이션의 업무 객체가 된다.
  - 외부의 무언가가 변경되어도, 엔티티가 변경될 가능성은 지극히 낮다.
  - 운영 관점에서 특정 어플리케이션에 무언가 변경이 필요하더라도 엔티티 계층에는 절대로 영향을 주어서는 안된다. (규칙 자체가 변경되지 않는 한 최고로 보호받아야 하는 영역)

## 유스케이스
- 유스케이스는 어플리케이션에 특화된 업무 규칙을 포함한다.
- 엔티티로 들어오고 나가는 데이터 흐름을 조정하며, 엔티티가 자신의 핵심 업무 규칙을 사용해서 유스케이스의 목적을 달성하도록 이끈다.
- 물론, 이 계층에서 발생한 변경이 엔티티에 영향을 줘서는 안된다. 또한 외부 요소에서 발생한 변경이 유스케이스에 영향을 줘서도 안된다.
  - 운영 관점에서 어플리케이션이 변경된다면 유스케이스는 영향을 받는다.

## 인터페이스 어댑터
- 어댑터는 유스케이스와 엔티티에 가장 편리한 형식에서 데이터베이서나 웹 같은 외부로 나가는 에이전시에게 가장 편리한 형식으로 변환한다.
  - Presenter, View, Controller 모두 인터페이스 어댑터 계층에 속한다.
  - Controller Request -> UseCase -> Presenter and View return
- 또한 엔티티와 유스케이스에서 가장 편리한 형식에서 데이터베이스가 이용하기에 가장 편리한 형식으로 변환한다.
- 외부 서비스의 형식에서 내부적인 형식으로 변환하는 어댑터 역할도 포함한다.
- 외부 -> 내부, 내부 -> 외부 변환 역할

## 프레임워크와 드라이버
- 가장 바깥쪽 계층은 일반적으로 데이터베이스나 웹 프레임워크와 같은 도구들로 구성된다.
- 모든 세부사항이 위치하는 곳으로, 이러한 세부사항을 모두 외부에 위치시켜서 피해를 최소화한다.

## 원은 네 개여야만 하나?
- 개수는 필요 없지만, 어떤 경우에도 의존성 규칙은 적용된다.
- 소스 코드 의존성은 항상 왼쪽을 향하고, 안쪽은 추상화와 고수준의 정책이다.

## 경계 횡단하기
- 제어 흐름과 소스 코드 의존성의 방향이 반대여야 하는 경우, 의존성 역전 원칙을 사용해서 해결한다.
- 유스케이스에서 프레젠터를 직접 호출해서는 안된다. 따라서 인터페이스를 호출하도록 하고, 외부의 프레젠터는 그 인터페이스를 구현하도록 만든다.
- 아키텍처 경계를 횡단할 때, 우리는 동적 다향성을 이용하여 소스 코드 의존성을 제어흐름과는 반대로 만들 수 있고, 이를 통해 의존성 규칙을 준수할 수 있다.

## 경계를 횡단하는 데이터는 어떤 모습인가
- DTO 등을 사용해서 데이터를 전송할 수 있고, 간단한 데이터 구조가 경계를 가로질러 전달된다.
- 경계를 가로질러 데이터를 전달 시, 데이터는 항상 내부의 원에서 사용하기에 가장 편리한 형태를 가져야만 한다. toXXX()

## 결론
- 이러한 규칙들을 준수함으로써, 향후에 겪을 수많은 고통거리를 덜어줄 수 있다.
- 소프트웨어를 계층으로 분리하고 의존성 규칙을 준수한다면 본질적으로 테스트하기 쉬운 시스템을 만들 수 있고, 이점을 누릴 수 있다.
- 외부 인프라나 데이터베이스 등 시스템의 외부 요소가 변경되더라도, 변경을 최소화하면서 갈아끼울 수 있다.
